<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>TaskPixel - 任务详情</title>
  <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect" />
  <link as="style"
    href="https://fonts.googleapis.com/css2?display=swap&amp;family=Press+Start+2P&amp;family=VT323:wght@400&amp;family=Inter:wght@400;500;600;700&amp;subset=latin"
    onload="this.rel='stylesheet'" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/styles.css">
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script src="js/tailwind-config.js"></script>
  <style>
    body {
      font-family: 'VT323', monospace;
      background-color: #f0f0f0;
    }

    .goal-item {
      color: #212121;
    }

    .pixel-border {
      border: 4px solid #212121;
      box-shadow: 4px 4px 0px #212121;
    }

    .pixel-button {
      border: 4px solid #212121;
      box-shadow: 4px 4px 0px #212121;
      transition: all 0.1s ease-out;
      will-change: transform, box-shadow;
      background-color: #ffffff;
      color: #212121;
      image-rendering: pixelated;
    }

    .pixel-button:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0px #212121;
    }

    .pixel-button:active {
      transform: translate(4px, 4px);
      box-shadow: 0px 0px 0px #212121;
    }

    .pixel-button-sm {
      border: 2px solid #212121;
      box-shadow: 2px 2px 0px #212121;
      transition: all 0.1s ease-out;
      will-change: transform, box-shadow;
    }

    .pixel-button-sm:hover {
      transform: translate(1px, 1px);
      box-shadow: 1px 1px 0px #212121;
    }

    .pixel-button-sm:active {
      transform: translate(2px, 2px);
      box-shadow: 0px 0px 0px #212121;
    }

    /* 目标和子步骤卡片内的无阴影按钮 */
    .pixel-button-flat {
      border: 2px solid #212121;
      box-shadow: none;
      transition: all 0.1s ease-out;
      image-rendering: pixelated;
    }

    .pixel-button-flat:hover {
      transform: none;
      box-shadow: none;
      opacity: 0.8;
    }

    .pixel-button-flat:active {
      transform: none;
      box-shadow: none;
      opacity: 0.6;
    }

    input[type="text"],
    input[type="number"],
    textarea {
      border: 4px solid #212121;
      box-shadow: inset 2px 2px 0px #a0a0a0, inset -2px -2px 0px #ffffff;
      background-color: #ffffff;
      font-family: 'VT323', monospace;
      font-size: 1.25rem;
      padding: 0.5rem;
      color: #212121;
      width: 100%;
    }

    input[type="checkbox"] {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border: 4px solid #212121;
      background-color: #fff;
      image-rendering: pixelated;
      box-shadow: inset 2px 2px 0px #a0a0a0, inset -2px -2px 0px #ffffff;
      position: relative;
      cursor: pointer;
      flex-shrink: 0;
    }

    input[type="checkbox"]:checked::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 12px;
      height: 12px;
      background-color: #212121;
      transform: translate(-50%, -50%);
      image-rendering: pixelated;
    }

    .text-shadow-sm {
      text-shadow: 2px 2px 0 #a0a0a0;
    }

    .progress-bar {
      height: 24px;
      border: 4px solid #212121;
      background-color: #e0e0e0;
      box-shadow: inset 2px 2px 0px #a0a0a0, inset -2px -2px 0px #ffffff;
      overflow: hidden;
    }

    .progress-bar-fill {
      background-color: #22c55e;
      height: 100%;
      image-rendering: pixelated;
      box-shadow: 2px 0 0 #16a34a;
    }

    /* 按钮图标样式 */
    .pixel-button {
      font-size: 14px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pixel-button-sm {
      font-size: 12px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pixel-button-flat {
      font-size: 12px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>

<body class="bg-background">
  <div class="flex h-full min-h-screen w-full flex-col font-body">
    <header
      class="flex items-center justify-between whitespace-nowrap border-b-4 border-pixel-border-color px-6 py-4 bg-white">
      <div class="flex items-center gap-4">
        <svg class="text-pixel-text-color" fill="none" height="32" viewBox="0 0 32 32" width="32"
          xmlns="http://www.w3.org/2000/svg">
          <path clip-rule="evenodd"
            d="M0 0H8V8H0V0ZM8 8H16V16H8V8ZM16 16H24V24H16V16ZM0 16H8V24H0V16ZM8 24H16V32H8V24ZM16 0H24V8H16V0ZM24 8H32V16H24V8Z"
            fill="currentColor" fill-rule="evenodd"></path>
        </svg>
        <h2 class="text-xl font-bold text-pixel-text-color">TaskPixel</h2>
      </div>
      <div class="hidden md:flex items-center gap-8 text-sm nav-links">
        <a class="text-black/70 hover:text-primary nav-link" href="index.html">主页</a>
        <a class="text-black/70 hover:text-primary nav-link" href="#">日历</a>
        <a class="text-black/70 hover:text-primary nav-link" href="goals.html">目标</a>
        <a class="text-black/70 hover:text-primary nav-link" href="settings.html">设置</a>
        <a class="text-black/70 hover:text-primary nav-link" href="data_management.html">数据管理</a>
      </div>
      <!-- header right-side intentionally removed: notifications and avatar placeholders -->
    </header>
    <main class="w-full flex-1 p-4 sm:p-6 md:p-10">
      <div class="mx-auto max-w-7xl">
        <!-- 左右两栏布局 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

          <!-- 左侧栏 -->
          <div class="space-y-8">
            <!-- 任务卡片 -->
            <div class="pixel-border bg-surface p-6">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                <h2 class="font-display text-2xl text-text-primary mb-4 sm:mb-0 task-title"></h2>
                <div class="flex items-center gap-2">
                  <span
                    class="font-display text-sm px-2 py-1 task-status bg-accent-yellow/20 text-accent-yellow-800 border-2 border-accent-yellow-800">进行中</span>
                </div>
              </div>
              <div class="space-y-6">
                <div>
                  <label class="block font-display text-lg text-text-primary mb-2" for="task-description">描述</label>
                  <p class="text-xl text-text-secondary task-description"></p>
                </div>
                <div class="mt-4">
                  <label class="block font-display text-lg text-text-primary mb-2" for="task-progress">进度</label>
                  <div class="progress-bar">
                    <div class="progress-bar-fill"></div>
                  </div>
                  <p class="text-right text-text-secondary text-lg mt-1 progress-text"></p>
                </div>
              </div>
              <div class="mt-8 flex items-center justify-end gap-4">
                <button
                  class="pixel-button back-button bg-pixel-secondary text-text-primary font-display py-2 px-4 text-sm flex items-center"
                  title="返回">
                  <span class="material-symbols-outlined align-middle">arrow_back</span>
                </button>
                <button
                  class="pixel-button edit-button bg-accent-blue text-white font-display py-2 px-4 text-sm flex items-center"
                  title="编辑任务">
                  <span class="material-symbols-outlined align-middle">edit</span>
                </button>
                <button
                  class="pixel-button complete-button bg-accent-green text-white font-display py-2 px-4 text-sm flex items-center"
                  title="标记为完成">
                  <span class="material-symbols-outlined align-middle">check_circle</span>
                </button>
              </div>
            </div>

            <!-- 目标和子步骤 -->
            <div class="pixel-border bg-surface p-6">
              <div class="space-y-6 goals-container">
                <!-- 目标和子步骤将通过JavaScript动态渲染 -->
              </div>
            </div>
          </div>

          <!-- 右侧栏 -->
          <div class="space-y-8">
            <!-- 记录工作进度 -->
            <div class="pixel-border bg-surface p-6">
              <h3 class="font-display text-2xl text-text-primary mb-6">记录工作进度</h3>
              <form id="timeline-form" class="space-y-6">
                <div>
                  <label class="block font-display text-lg text-text-primary mb-2" for="work-content">工作内容</label>
                  <textarea id="work-content" placeholder="描述您的工作..." rows="4"></textarea>
                </div>
                <div>
                  <label class="block font-display text-lg text-text-primary mb-2" for="time-spent">时间 (小时)</label>
                  <input id="time-spent" placeholder="如：2" type="number" step="0.1" min="0.1" />
                </div>
                <div>
                  <button type="submit"
                    class="pixel-button w-full bg-accent-green text-white font-display py-3 px-4 text-sm flex items-center justify-center gap-2"
                    title="记录进度">
                    <span>💾</span>
                    <span>记录进度</span>
                  </button>
                </div>
              </form>
            </div>

            <!-- 进度历史 -->
            <div class="pixel-border bg-surface p-6">
              <h3 class="font-display text-2xl text-text-primary mb-6">进度历史</h3>
              <div class="space-y-4 timeline-container">
                <!-- 时间线记录将通过JavaScript动态渲染 -->
              </div>
            </div>
          </div>

        </div>
      </div>
    </main>
  </div>

  <script>
    // 确保 TaskPixel 名称空间存在，即使 core.js 未能正确加载
    window.TaskPixel = window.TaskPixel || {};

    // 统一的编辑任务函数
    function editTask(taskId) {
      if (!taskId) {
        alert('未找到任务ID');
        return;
      }

      try {
        const raw = localStorage.getItem('taskpixel_data');
        if (!raw) {
          alert('未找到任务数据');
          return;
        }

        const data = JSON.parse(raw);
        const task = data.tasks.find(t => t.id === taskId);

        if (!task) {
          alert('未找到指定任务');
          return;
        }

        // 创建编辑对话框
        const dialogElement = document.createElement('div');
        dialogElement.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
        dialogElement.id = 'edit-task-dialog';

        // 计算当前进度，决定状态选项
        let currentProgress = window.TaskPixel?.DataStoreAdapter?.getTaskProgress(taskId) || task.progress || 0;
        let currentStatus = task.status || 'in-progress';
        let isCompleted = currentProgress >= 100;

        dialogElement.innerHTML = `
          <div class="pixel-border bg-white p-6 w-full max-w-lg">
            <h2 class="text-2xl font-display mb-6">编辑任务</h2>
            <form id="edit-task-form">
              <div class="mb-4">
                <label class="block font-display text-lg mb-2" for="edit-task-title">任务标题</label>
                <input type="text" id="edit-task-title" class="w-full" required placeholder="输入任务标题" value="${task.title || ''}">
              </div>
              <div class="mb-4">
                <label class="block font-display text-lg mb-2" for="edit-task-description">任务描述</label>
                <textarea id="edit-task-description" class="w-full h-32" placeholder="输入任务描述">${task.description || ''}</textarea>
              </div>
              ${isCompleted ? `
              <div class="mb-4">
                <label class="block font-display text-lg mb-2">状态</label>
                <div class="w-full p-2 bg-green-100 text-green-800 border border-green-300 rounded">
                  ✅ 已完成（进度100%，自动设置）
                </div>
              </div>
              ` : `
              <div class="mb-4">
                <label class="block font-display text-lg mb-2" for="edit-task-status">状态</label>
                <select id="edit-task-status" class="w-full">
                  <option value="in-progress" ${currentStatus === 'in-progress' || currentStatus === 'todo' ? 'selected' : ''}>进行中</option>
                  <option value="on-hold" ${currentStatus === 'on-hold' ? 'selected' : ''}>搁置</option>
                </select>
              </div>
              `}
              <div class="mb-4">
                <label class="block font-display text-lg mb-2">当前进度: ${currentProgress}%</label>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="bg-blue-600 h-2 rounded-full" style="width: ${currentProgress}%"></div>
                </div>
              </div>
              <div class="flex justify-end gap-4">
                <button type="button" id="cancel-edit-task" class="pixel-button">取消</button>
                <button type="submit" class="pixel-button bg-primary text-white">保存</button>
              </div>
            </form>
          </div>
        `;

        document.body.appendChild(dialogElement);

        // 绑定表单提交事件
        document.getElementById('edit-task-form').addEventListener('submit', function (e) {
          e.preventDefault();

          const title = document.getElementById('edit-task-title').value.trim();
          const description = document.getElementById('edit-task-description').value.trim();

          if (!title) {
            alert('任务标题不能为空');
            return;
          }

          // 确定最终状态
          let finalStatus;
          const progress = window.TaskPixel?.DataStoreAdapter?.getTaskProgress(taskId) || task.progress || 0;

          if (progress >= 100) {
            finalStatus = 'completed';
          } else {
            const statusSelect = document.getElementById('edit-task-status');
            finalStatus = statusSelect ? statusSelect.value : 'in-progress';
          }

          // 更新任务数据
          task.title = title;
          task.description = description;
          task.status = finalStatus;

          // 保存到localStorage
          localStorage.setItem('taskpixel_data', JSON.stringify(data));

          // 关闭对话框
          document.getElementById('edit-task-dialog').remove();

          // 刷新页面
          location.reload();
        });

        // 绑定取消按钮
        document.getElementById('cancel-edit-task').addEventListener('click', function () {
          document.getElementById('edit-task-dialog').remove();
        });

      } catch (e) {
        alert('编辑任务出错: ' + e.message);
      }
    }

    // 统一的完成任务函数
    function completeTask(taskId) {
      if (!taskId) {
        alert('未找到任务ID');
        return;
      }

      try {
        const raw = localStorage.getItem('taskpixel_data');
        if (!raw) {
          alert('未找到任务数据');
          return;
        }

        const data = JSON.parse(raw);
        const task = data.tasks.find(t => t.id === taskId);

        if (!task) {
          alert('未找到指定任务');
          return;
        }

        // 切换完成状态
        task.status = task.status === 'completed' ? 'in-progress' : 'completed';

        // 如果标记为完成，设置进度为100%
        if (task.status === 'completed') {
          task.progress = 100;
        }

        // 保存到localStorage
        localStorage.setItem('taskpixel_data', JSON.stringify(data));

        // 刷新页面
        location.reload();

      } catch (e) {
        alert('更新任务状态时出错: ' + e.message);
      }
    }

    // 添加工作进度记录
    function addWorkProgress(taskId, content, hours) {
      if (!taskId) {
        alert('未找到任务ID');
        return;
      }

      try {
        const raw = localStorage.getItem('taskpixel_data');
        if (!raw) {
          alert('未找到任务数据');
          return;
        }

        const data = JSON.parse(raw);
        const task = data.tasks.find(t => t.id === taskId);

        if (!task) {
          alert('未找到指定任务');
          return;
        }

        // 初始化timeline数组
        if (!task.timeline) {
          task.timeline = [];
        }

        // 创建新的进度记录
        const progressEntry = {
          id: 'progress-' + Date.now(),
          date: new Date().toISOString(),
          content: content,
          hours: hours,
          timestamp: Date.now()
        };

        task.timeline.push(progressEntry);

        // 更新总工作时间
        const totalHours = task.timeline.reduce((sum, entry) => sum + (entry.hours || 0), 0);
        task.totalHours = totalHours;

        // 保存到localStorage
        localStorage.setItem('taskpixel_data', JSON.stringify(data));

        // 清空表单
        document.getElementById('work-content').value = '';
        document.getElementById('time-spent').value = '';

        // 重新渲染进度历史
        renderProgressHistory(task.timeline);

        alert('工作进度记录成功！');

      } catch (e) {
        alert('记录工作进度时出错: ' + e.message);
      }
    }

    // 渲染进度历史
    function renderProgressHistory(timeline) {
      const container = document.querySelector('.timeline-container');
      if (!container) return;

      container.innerHTML = '';

      if (!timeline || timeline.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8">
            <p class="text-gray-500 mb-4">还没有工作进度记录</p>
            <p class="text-gray-400 text-sm">开始记录您的工作进度吧！</p>
          </div>
        `;
        return;
      }

      // 按时间倒序排列
      const sortedTimeline = [...timeline].sort((a, b) => b.timestamp - a.timestamp);

      sortedTimeline.forEach(entry => {
        const entryElement = document.createElement('div');
        entryElement.className = 'pixel-border bg-white p-4 mb-4 hover:shadow-lg transition-shadow';

        const date = new Date(entry.date);
        const formattedDate = date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });

        entryElement.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <div class="flex items-center gap-2">
              <div class="w-3 h-3 bg-primary"></div>
              <span class="font-display text-sm text-gray-600">${formattedDate}</span>
            </div>
            <span class="pixel-button bg-primary text-white px-3 py-1 text-xs">${entry.hours} 小时</span>
          </div>
          <div class="pl-5">
            <p class="font-display text-lg text-text-primary">${entry.content}</p>
          </div>
        `;

        container.appendChild(entryElement);
      });
    }
  </script>
  <script src="js/core.js"></script>
  <script src="js/dataStoreAdapter.js"></script>
  <script src="js/aiAssist.js"></script>
  <script src="js/taskDetail.js"></script>
  <script src="js/taskDetailFix-clean.js"></script>
  <script src="js/taskProgressFix-clean.js"></script>
  <script src="js/goalsFix-clean.js"></script>
  <script>
    // 简化的初始化脚本 - 移除所有调试输出
    document.addEventListener('DOMContentLoaded', function () {
      // 基础按钮事件
      document.querySelector('.back-button')?.addEventListener('click', function () {
        window.location.href = 'index.html';
      });

      document.querySelector('.edit-button')?.addEventListener('click', function () {
        const taskId = new URLSearchParams(window.location.search).get('id') || window.currentTaskId;
        editTask(taskId);
      });

      document.querySelector('.complete-button')?.addEventListener('click', function () {
        const taskId = new URLSearchParams(window.location.search).get('id');
        completeTask(taskId);
      });

      // 记录工作进度表单处理
      document.getElementById('timeline-form')?.addEventListener('submit', function (e) {
        e.preventDefault();
        const taskId = new URLSearchParams(window.location.search).get('id');
        const workContent = document.getElementById('work-content').value.trim();
        const timeSpent = parseFloat(document.getElementById('time-spent').value);

        if (!workContent) {
          alert('请输入工作内容');
          return;
        }
        if (!timeSpent || timeSpent <= 0) {
          alert('请输入有效的工作时间');
          return;
        }

        addWorkProgress(taskId, workContent, timeSpent);
      });

      // 初始化 TaskPixel
      try {
        if (typeof TaskPixel?.init === 'function') {
          TaskPixel.init();
        }
      } catch (e) {
        // 静默处理错误
      }

      // 初始化 TaskDetail
      try {
        const taskId = new URLSearchParams(window.location.search).get('id');
        if (taskId && window.TaskPixel?.TaskDetail?.init) {
          window.currentTaskId = taskId;
          TaskPixel.TaskDetail.currentTaskId = taskId;
          TaskPixel.TaskDetail.init();
        }
      } catch (e) {
        // 静默处理错误
      }

      // 备用数据显示逻辑 - 确保任务信息能够显示
      setTimeout(function () {
        const taskId = new URLSearchParams(window.location.search).get('id');
        if (taskId) {
          try {
            const raw = localStorage.getItem('taskpixel_data');
            if (raw) {
              const data = JSON.parse(raw);
              const task = (data.tasks || []).find(t => t.id === taskId);

              if (task) {
                // 更新标题
                const titleEl = document.querySelector('.task-title');
                if (titleEl && !titleEl.textContent.includes(task.title)) {
                  titleEl.textContent = '任务: ' + task.title;
                }

                // 更新描述
                const descEl = document.querySelector('.task-description');
                if (descEl && !descEl.textContent) {
                  descEl.textContent = task.description || '暂无描述';
                }

                // 更新进度 - 使用统一的 updateProgressBar 函数
                updateProgressBar(taskId);

                // 更新状态
                const statusEl = document.querySelector('.task-status');
                if (statusEl) {
                  let statusText = '进行中';
                  let statusClass = 'bg-accent-yellow/20 text-accent-yellow-800 border-accent-yellow-800';

                  switch (task.status) {
                    case 'todo':
                      statusText = '待处理';
                      statusClass = 'bg-accent-blue/20 text-accent-blue-800 border-accent-blue-800';
                      break;
                    case 'on-hold':
                      statusText = '搁置';
                      statusClass = 'bg-accent-red/20 text-accent-red-800 border-accent-red-800';
                      break;
                    case 'completed':
                      statusText = '已完成';
                      statusClass = 'bg-accent-green/20 text-accent-green-800 border-accent-green-800';
                      break;
                    case 'in-progress':
                    default:
                      statusText = '进行中';
                      statusClass = 'bg-accent-yellow/20 text-accent-yellow-800 border-accent-yellow-800';
                      break;
                  }
                  statusEl.textContent = statusText;

                  // 更新状态样式
                  statusEl.className = `font-display text-sm px-2 py-1 task-status border-2 ${statusClass}`;
                }

                // 渲染目标
                const goalsContainer = document.querySelector('.goals-container');
                if (goalsContainer) {
                  renderGoals(task.goals || [], taskId);
                  // 渲染目标后更新进度条
                  updateProgressBar(taskId);
                }

                // 渲染进度历史
                if (task.timeline) {
                  renderProgressHistory(task.timeline);
                }
              }
            }
          } catch (e) {
            // 静默处理错误
          }
        }
      }, 1000);

      // 目标渲染函数
      function renderGoals(goals, taskId) {
        const goalsContainer = document.querySelector('.goals-container');
        if (!goalsContainer) return;

        // 清空容器
        goalsContainer.innerHTML = '';

        // 添加标题和AI助手按钮
        const header = document.createElement('div');
        header.className = 'flex items-center justify-between mb-6';
        header.innerHTML = `
          <h3 class="font-display text-2xl text-text-primary">目标与子步骤</h3>
          <button class="pixel-button bg-purple-600 text-white px-4 py-2 text-sm">
            <span class="mr-2">✨</span>AI 助手
          </button>
        `;
        goalsContainer.appendChild(header);

        // 渲染目标列表
        if (goals && goals.length > 0) {
          goals.forEach(goal => {
            const goalCard = createGoalCard(goal, taskId);
            goalsContainer.appendChild(goalCard);
          });

          // 添加"添加新目标"按钮
          const addButton = document.createElement('div');
          addButton.className = 'text-center mt-6';
          addButton.innerHTML = `
            <button class="pixel-button bg-primary text-white px-4 py-2 add-goal-btn" title="添加新目标">🎯 ➕</button>
          `;
          goalsContainer.appendChild(addButton);
        } else {
          // 空状态
          const emptyState = document.createElement('div');
          emptyState.className = 'text-center py-8';
          emptyState.innerHTML = `
            <p class="text-gray-500 mb-4">还没有设置目标</p>
            <button class="pixel-button bg-primary text-white px-4 py-2 add-goal-btn" title="添加目标">🎯 ➕</button>
          `;
          goalsContainer.appendChild(emptyState);
        }

        // 绑定添加目标按钮
        bindAddGoalEvents(taskId);
      }

      // 创建目标卡片
      function createGoalCard(goal, taskId) {
        const card = document.createElement('div');
        card.className = 'border-4 border-black bg-white mb-6 p-4 goal-card';
        card.dataset.goalId = goal.id;

        // 计算进度
        const total = goal.substeps ? goal.substeps.length : 0;
        const completed = goal.substeps ? goal.substeps.filter(s => s.completed).length : 0;

        card.innerHTML = `
          <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
              <h4 class="font-display text-lg font-bold mb-2">${goal.title || '未命名目标'}</h4>
              <p class="text-gray-600 text-sm mb-2">${goal.description || ''}</p>
            </div>
            <div class="flex gap-2">
              <button class="pixel-button-flat bg-green-500 text-white px-3 py-1 text-xs edit-goal-btn" 
                      data-goal-id="${goal.id}" title="修改目标">✏️</button>
              <button class="pixel-button-flat bg-blue-500 text-white px-3 py-1 text-xs add-substep-btn" 
                      data-goal-id="${goal.id}" title="添加子步骤">➕</button>
              <button class="pixel-button-flat bg-red-500 text-white px-3 py-1 text-xs delete-goal-btn" 
                      data-goal-id="${goal.id}" title="删除目标">🗑️</button>
            </div>
          </div>
          
          <div class="substeps-container">
            ${goal.substeps ? goal.substeps.map(substep => `
              <div class="flex items-center gap-3 py-2 px-3 hover:bg-gray-50 substep-item" data-substep-id="${substep.id}">
                <input type="checkbox" ${substep.completed ? 'checked' : ''} 
                       class="substep-checkbox w-4 h-4" 
                       data-goal-id="${goal.id}" 
                       data-substep-id="${substep.id}">
                <span class="flex-1 ${substep.completed ? 'line-through text-gray-500' : ''}">${substep.content || substep.title}</span>
                <div class="flex gap-1">
                  <button class="pixel-button-flat bg-green-500 text-white px-2 py-1 text-xs edit-substep-btn" 
                          data-goal-id="${goal.id}" 
                          data-substep-id="${substep.id}" title="修改子步骤">✏️</button>
                  <button class="pixel-button-flat bg-red-500 text-white px-2 py-1 text-xs delete-substep-btn" 
                          data-goal-id="${goal.id}" 
                          data-substep-id="${substep.id}" title="删除子步骤">🗑️</button>
                </div>
              </div>
            `).join('') : ''}
          </div>
        `;

        // 绑定事件
        bindGoalCardEvents(card, goal, taskId);

        return card;
      }

      // 绑定目标卡片事件
      function bindGoalCardEvents(card, goal, taskId) {
        // 添加子步骤
        const addBtn = card.querySelector('.add-substep-btn');
        if (addBtn) {
          addBtn.addEventListener('click', () => openAddSubstepDialog(goal.id, taskId));
        }

        // 修改目标
        const editBtn = card.querySelector('.edit-goal-btn');
        if (editBtn) {
          editBtn.addEventListener('click', () => openEditGoalDialog(goal.id, taskId));
        }

        // 删除目标
        const deleteBtn = card.querySelector('.delete-goal-btn');
        if (deleteBtn) {
          deleteBtn.addEventListener('click', () => {
            if (confirm('确定要删除这个目标吗？')) {
              deleteGoal(taskId, goal.id);
            }
          });
        }

        // 复选框事件
        const checkboxes = card.querySelectorAll('.substep-checkbox');
        checkboxes.forEach(checkbox => {
          checkbox.addEventListener('change', function () {
            updateSubstepStatus(
              taskId,
              this.dataset.goalId,
              this.dataset.substepId,
              this.checked
            );
          });
        });

        // 修改子步骤按钮
        const editSubstepButtons = card.querySelectorAll('.edit-substep-btn');
        editSubstepButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            openEditSubstepDialog(taskId, btn.dataset.goalId, btn.dataset.substepId);
          });
        });

        // 删除子步骤按钮
        const deleteButtons = card.querySelectorAll('.delete-substep-btn');
        deleteButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            if (confirm('确定要删除这个子步骤吗？')) {
              deleteSubstep(taskId, btn.dataset.goalId, btn.dataset.substepId);
            }
          });
        });
      }

      // 绑定添加目标事件
      function bindAddGoalEvents(taskId) {
        const addBtns = document.querySelectorAll('.add-goal-btn');
        addBtns.forEach(btn => {
          btn.addEventListener('click', () => openAddGoalDialog(taskId));
        });
      }

      // 打开添加目标对话框
      function openAddGoalDialog(taskId) {
        const dialog = document.createElement('div');
        dialog.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
        dialog.id = 'add-goal-dialog';

        dialog.innerHTML = `
          <div class="pixel-border bg-white p-6 w-full max-w-lg">
            <h2 class="text-2xl font-display mb-6">添加目标</h2>
            <form id="add-goal-form">
              <div class="mb-4">
                <label class="block font-display text-lg mb-2" for="goal-title">目标标题 *</label>
                <input type="text" id="goal-title" class="w-full" required placeholder="输入目标标题">
              </div>
              <div class="mb-4">
                <label class="block font-display text-lg mb-2" for="goal-description">目标描述</label>
                <textarea id="goal-description" class="w-full h-32" placeholder="输入目标描述（可选）"></textarea>
              </div>
              <div class="flex justify-end gap-4">
                <button type="button" id="cancel-add-goal" class="pixel-button">取消</button>
                <button type="submit" class="pixel-button bg-primary text-white">添加</button>
              </div>
            </form>
          </div>
        `;

        document.body.appendChild(dialog);

        // 绑定事件
        document.getElementById('add-goal-form').addEventListener('submit', function (e) {
          e.preventDefault();
          const title = document.getElementById('goal-title').value.trim();
          const description = document.getElementById('goal-description').value.trim();

          if (!title) {
            alert('请输入目标标题');
            return;
          }

          addGoal(taskId, title, description);
          dialog.remove();
        });

        document.getElementById('cancel-add-goal').addEventListener('click', () => {
          dialog.remove();
        });

        // 聚焦到标题输入框
        setTimeout(() => {
          document.getElementById('goal-title').focus();
        }, 100);
      }

      // 添加目标
      function addGoal(taskId, title, description) {
        try {
          const raw = localStorage.getItem('taskpixel_data');
          if (raw) {
            const data = JSON.parse(raw);
            const task = data.tasks.find(t => t.id === taskId);
            if (task) {
              if (!task.goals) task.goals = [];

              const newGoal = {
                id: 'goal-' + Date.now(),
                title: title,
                description: description || '',
                substeps: []
              };

              task.goals.push(newGoal);
              localStorage.setItem('taskpixel_data', JSON.stringify(data));

              // 重新渲染
              renderGoals(task.goals, taskId);
            }
          }
        } catch (e) {
          alert('添加目标失败: ' + e.message);
        }
      }

      // 打开修改目标对话框
      function openEditGoalDialog(goalId, taskId) {
        try {
          const raw = localStorage.getItem('taskpixel_data');
          if (!raw) return;

          const data = JSON.parse(raw);
          const task = data.tasks.find(t => t.id === taskId);
          if (!task || !task.goals) return;

          const goal = task.goals.find(g => g.id === goalId);
          if (!goal) return;

          const dialog = document.createElement('div');
          dialog.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
          dialog.id = 'edit-goal-dialog';

          dialog.innerHTML = `
            <div class="pixel-border bg-white p-6 w-full max-w-lg">
              <h2 class="text-2xl font-display mb-6">修改目标</h2>
              <form id="edit-goal-form">
                <div class="mb-4">
                  <label class="block font-display text-lg mb-2" for="edit-goal-title">目标标题 *</label>
                  <input type="text" id="edit-goal-title" class="w-full" required placeholder="输入目标标题" value="${goal.title || ''}">
                </div>
                <div class="mb-4">
                  <label class="block font-display text-lg mb-2" for="edit-goal-description">目标描述</label>
                  <textarea id="edit-goal-description" class="w-full h-32" placeholder="输入目标描述（可选）">${goal.description || ''}</textarea>
                </div>
                <div class="flex justify-end gap-4">
                  <button type="button" id="cancel-edit-goal" class="pixel-button">取消</button>
                  <button type="submit" class="pixel-button bg-primary text-white">保存</button>
                </div>
              </form>
            </div>
          `;

          document.body.appendChild(dialog);

          // 绑定事件
          document.getElementById('edit-goal-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const title = document.getElementById('edit-goal-title').value.trim();
            const description = document.getElementById('edit-goal-description').value.trim();

            if (!title) {
              alert('请输入目标标题');
              return;
            }

            // 更新目标
            goal.title = title;
            goal.description = description;
            localStorage.setItem('taskpixel_data', JSON.stringify(data));

            // 重新渲染
            renderGoals(task.goals, taskId);
            dialog.remove();
          });

          document.getElementById('cancel-edit-goal').addEventListener('click', () => {
            dialog.remove();
          });

          // 聚焦到标题输入框
          setTimeout(() => {
            document.getElementById('edit-goal-title').focus();
          }, 100);

        } catch (e) {
          alert('修改目标失败: ' + e.message);
        }
      }

      // 删除目标
      function deleteGoal(taskId, goalId) {
        try {
          const raw = localStorage.getItem('taskpixel_data');
          if (raw) {
            const data = JSON.parse(raw);
            const task = data.tasks.find(t => t.id === taskId);
            if (task && task.goals) {
              task.goals = task.goals.filter(g => g.id !== goalId);
              localStorage.setItem('taskpixel_data', JSON.stringify(data));

              // 重新渲染
              renderGoals(task.goals, taskId);
              updateProgressBar(taskId);
            }
          }
        } catch (e) {
          alert('删除目标失败: ' + e.message);
        }
      }

      // 打开添加子步骤对话框
      function openAddSubstepDialog(goalId, taskId) {
        const dialog = document.createElement('div');
        dialog.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
        dialog.id = 'add-substep-dialog';

        dialog.innerHTML = `
          <div class="pixel-border bg-white p-6 w-full max-w-lg">
            <h2 class="text-2xl font-display mb-6">添加子步骤</h2>
            <form id="add-substep-form">
              <div class="mb-4">
                <label class="block font-display text-lg mb-2" for="substep-content">子步骤内容 *</label>
                <input type="text" id="substep-content" class="w-full" required placeholder="输入子步骤内容">
              </div>
              <div class="flex justify-end gap-4">
                <button type="button" id="cancel-add-substep" class="pixel-button">取消</button>
                <button type="submit" class="pixel-button bg-primary text-white">添加</button>
              </div>
            </form>
          </div>
        `;

        document.body.appendChild(dialog);

        // 绑定事件
        document.getElementById('add-substep-form').addEventListener('submit', function (e) {
          e.preventDefault();
          const content = document.getElementById('substep-content').value.trim();

          if (!content) {
            alert('请输入子步骤内容');
            return;
          }

          addSubstep(goalId, taskId, content);
          dialog.remove();
        });

        document.getElementById('cancel-add-substep').addEventListener('click', () => {
          dialog.remove();
        });

        // 聚焦到内容输入框
        setTimeout(() => {
          document.getElementById('substep-content').focus();
        }, 100);
      }

      // 添加子步骤
      function addSubstep(goalId, taskId, content) {
        try {
          const raw = localStorage.getItem('taskpixel_data');
          if (raw) {
            const data = JSON.parse(raw);
            const task = data.tasks.find(t => t.id === taskId);
            if (task && task.goals) {
              const goal = task.goals.find(g => g.id === goalId);
              if (goal) {
                if (!goal.substeps) goal.substeps = [];

                const newSubstep = {
                  id: 'substep-' + Date.now(),
                  content: content,
                  completed: false
                };

                goal.substeps.push(newSubstep);
                localStorage.setItem('taskpixel_data', JSON.stringify(data));

                // 重新渲染
                renderGoals(task.goals, taskId);
                updateProgressBar(taskId);
              }
            }
          }
        } catch (e) {
          alert('添加子步骤失败: ' + e.message);
        }
      }

      // 打开修改子步骤对话框
      function openEditSubstepDialog(taskId, goalId, substepId) {
        try {
          const raw = localStorage.getItem('taskpixel_data');
          if (!raw) return;

          const data = JSON.parse(raw);
          const task = data.tasks.find(t => t.id === taskId);
          if (!task || !task.goals) return;

          const goal = task.goals.find(g => g.id === goalId);
          if (!goal || !goal.substeps) return;

          const substep = goal.substeps.find(s => s.id === substepId);
          if (!substep) return;

          const dialog = document.createElement('div');
          dialog.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
          dialog.id = 'edit-substep-dialog';

          dialog.innerHTML = `
            <div class="pixel-border bg-white p-6 w-full max-w-lg">
              <h2 class="text-2xl font-display mb-6">修改子步骤</h2>
              <form id="edit-substep-form">
                <div class="mb-4">
                  <label class="block font-display text-lg mb-2" for="edit-substep-content">子步骤内容 *</label>
                  <input type="text" id="edit-substep-content" class="w-full" required placeholder="输入子步骤内容" value="${substep.content || substep.title || ''}">
                </div>
                <div class="mb-4">
                  <label class="flex items-center">
                    <input type="checkbox" id="edit-substep-completed" ${substep.completed ? 'checked' : ''} class="mr-2">
                    <span class="font-display text-lg">已完成</span>
                  </label>
                </div>
                <div class="flex justify-end gap-4">
                  <button type="button" id="cancel-edit-substep" class="pixel-button">取消</button>
                  <button type="submit" class="pixel-button bg-primary text-white">保存</button>
                </div>
              </form>
            </div>
          `;

          document.body.appendChild(dialog);

          // 绑定事件
          document.getElementById('edit-substep-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const content = document.getElementById('edit-substep-content').value.trim();
            const completed = document.getElementById('edit-substep-completed').checked;

            if (!content) {
              alert('请输入子步骤内容');
              return;
            }

            // 更新子步骤
            substep.content = content;
            substep.completed = completed;
            localStorage.setItem('taskpixel_data', JSON.stringify(data));

            // 重新渲染
            renderGoals(task.goals, taskId);
            updateProgressBar(taskId);
            dialog.remove();
          });

          document.getElementById('cancel-edit-substep').addEventListener('click', () => {
            dialog.remove();
          });

          // 聚焦到内容输入框
          setTimeout(() => {
            document.getElementById('edit-substep-content').focus();
          }, 100);

        } catch (e) {
          alert('修改子步骤失败: ' + e.message);
        }
      }

      // 删除子步骤
      function deleteSubstep(taskId, goalId, substepId) {
        try {
          const raw = localStorage.getItem('taskpixel_data');
          if (raw) {
            const data = JSON.parse(raw);
            const task = data.tasks.find(t => t.id === taskId);
            if (task && task.goals) {
              const goal = task.goals.find(g => g.id === goalId);
              if (goal && goal.substeps) {
                goal.substeps = goal.substeps.filter(s => s.id !== substepId);
                localStorage.setItem('taskpixel_data', JSON.stringify(data));

                // 重新渲染
                renderGoals(task.goals, taskId);
                updateProgressBar(taskId);
              }
            }
          }
        } catch (e) {
          alert('删除子步骤失败: ' + e.message);
        }
      }

      // 更新子步骤状态
      function updateSubstepStatus(taskId, goalId, substepId, completed) {
        try {
          const raw = localStorage.getItem('taskpixel_data');
          if (raw) {
            const data = JSON.parse(raw);
            const task = data.tasks.find(t => t.id === taskId);
            if (task && task.goals) {
              const goal = task.goals.find(g => g.id === goalId);
              if (goal && goal.substeps) {
                const substep = goal.substeps.find(s => s.id === substepId);
                if (substep) {
                  substep.completed = completed;
                  localStorage.setItem('taskpixel_data', JSON.stringify(data));

                  // 重新渲染以更新进度
                  renderGoals(task.goals, taskId);
                  updateProgressBar(taskId);
                }
              }
            }
          }
        } catch (e) {
          alert('更新子步骤状态失败: ' + e.message);
        }
      }

      // 更新进度条
      function updateProgressBar(taskId) {
        if (!taskId) {
          console.warn('updateProgressBar: taskId is missing');
          return;
        }

        setTimeout(() => {
          try {
            // 获取实际进度
            let actualProgress = 0;

            if (window.TaskPixel?.DataStoreAdapter?.getTaskProgress) {
              actualProgress = window.TaskPixel.DataStoreAdapter.getTaskProgress(taskId);
            } else {
              // 备用计算方法
              const raw = localStorage.getItem('taskpixel_data');
              if (raw) {
                const data = JSON.parse(raw);
                const task = data.tasks?.find(t => t.id === taskId);
                if (task) {
                  // 计算基于目标和子步骤的进度
                  let totalSubsteps = 0;
                  let completedSubsteps = 0;

                  if (task.goals && Array.isArray(task.goals)) {
                    task.goals.forEach(goal => {
                      if (goal.substeps && Array.isArray(goal.substeps)) {
                        goal.substeps.forEach(substep => {
                          totalSubsteps++;
                          if (substep.completed) {
                            completedSubsteps++;
                          }
                        });
                      }
                    });
                  }

                  actualProgress = totalSubsteps > 0 ? Math.round((completedSubsteps / totalSubsteps) * 100) : 0;
                }
              }
            }

            // 更新进度条
            const progressEl = document.querySelector('.progress-bar-fill');
            const progressTextEl = document.querySelector('.progress-text');

            if (progressEl) {
              progressEl.style.width = actualProgress + '%';
            }
            if (progressTextEl) {
              progressTextEl.textContent = actualProgress + '% 完成';
            }

            console.log(`Progress updated for task ${taskId}: ${actualProgress}%`);

          } catch (e) {
            console.error('Error updating progress bar:', e);
          }
        }, 100);
      }

    });
  </script>
</body>

</html>