<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>TaskPixel - ä»»åŠ¡è¯¦æƒ…</title>
  <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect" />
  <link as="style"
    href="https://fonts.googleapis.com/css2?display=swap&amp;family=Press+Start+2P&amp;family=VT323:wght@400&amp;family=Inter:wght@400;500;600;700&amp;subset=latin"
    onload="this.rel='stylesheet'" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/styles.css">
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script src="js/tailwind-config.js"></script>
  <style>
    body {
      font-family: 'VT323', monospace;
      background-color: #f0f0f0;
    }

    .goal-item {
      color: #212121;
    }

    .pixel-border {
      border: 4px solid #212121;
      box-shadow: 4px 4px 0px #212121;
    }

    .pixel-button {
      border: 4px solid #212121;
      box-shadow: 4px 4px 0px #212121;
      transition: all 0.1s ease-out;
      will-change: transform, box-shadow;
      background-color: #ffffff;
      color: #212121;
      image-rendering: pixelated;
    }

    .pixel-button:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0px #212121;
    }

    .pixel-button:active {
      transform: translate(4px, 4px);
      box-shadow: 0px 0px 0px #212121;
    }

    .pixel-button-sm {
      border: 2px solid #212121;
      box-shadow: 2px 2px 0px #212121;
      transition: all 0.1s ease-out;
      will-change: transform, box-shadow;
    }

    .pixel-button-sm:hover {
      transform: translate(1px, 1px);
      box-shadow: 1px 1px 0px #212121;
    }

    .pixel-button-sm:active {
      transform: translate(2px, 2px);
      box-shadow: 0px 0px 0px #212121;
    }

    /* ç›®æ ‡å’Œå­æ­¥éª¤å¡ç‰‡å†…çš„æ— é˜´å½±æŒ‰é’® */
    .pixel-button-flat {
      border: 2px solid #212121;
      box-shadow: none;
      transition: all 0.1s ease-out;
      image-rendering: pixelated;
    }

    .pixel-button-flat:hover {
      transform: none;
      box-shadow: none;
      opacity: 0.8;
    }

    .pixel-button-flat:active {
      transform: none;
      box-shadow: none;
      opacity: 0.6;
    }

    input[type="text"],
    input[type="number"],
    textarea {
      border: 4px solid #212121;
      box-shadow: inset 2px 2px 0px #a0a0a0, inset -2px -2px 0px #ffffff;
      background-color: #ffffff;
      font-family: 'VT323', monospace;
      font-size: 1.25rem;
      padding: 0.5rem;
      color: #212121;
      width: 100%;
    }

    input[type="checkbox"] {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border: 4px solid #212121;
      background-color: #fff;
      image-rendering: pixelated;
      box-shadow: inset 2px 2px 0px #a0a0a0, inset -2px -2px 0px #ffffff;
      position: relative;
      cursor: pointer;
      flex-shrink: 0;
    }

    input[type="checkbox"]:checked::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 12px;
      height: 12px;
      background-color: #212121;
      transform: translate(-50%, -50%);
      image-rendering: pixelated;
    }

    .text-shadow-sm {
      text-shadow: 2px 2px 0 #a0a0a0;
    }

    .progress-bar {
      height: 24px;
      border: 4px solid #212121;
      background-color: #e0e0e0;
      box-shadow: inset 2px 2px 0px #a0a0a0, inset -2px -2px 0px #ffffff;
      overflow: hidden;
    }

    .progress-bar-fill {
      background-color: #22c55e;
      height: 100%;
      image-rendering: pixelated;
      box-shadow: 2px 0 0 #16a34a;
    }

    /* æŒ‰é’®å›¾æ ‡æ ·å¼ */
    .pixel-button {
      font-size: 14px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pixel-button-sm {
      font-size: 12px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pixel-button-flat {
      font-size: 12px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>

<body class="bg-background">
  <div class="flex h-full min-h-screen w-full flex-col font-body">
    <header
      class="flex items-center justify-between whitespace-nowrap border-b-4 border-pixel-border-color px-6 py-4 bg-white">
      <div class="flex items-center gap-4">
        <svg class="text-pixel-text-color" fill="none" height="32" viewBox="0 0 32 32" width="32"
          xmlns="http://www.w3.org/2000/svg">
          <path clip-rule="evenodd"
            d="M0 0H8V8H0V0ZM8 8H16V16H8V8ZM16 16H24V24H16V16ZM0 16H8V24H0V16ZM8 24H16V32H8V24ZM16 0H24V8H16V0ZM24 8H32V16H24V8Z"
            fill="currentColor" fill-rule="evenodd"></path>
        </svg>
        <h2 class="text-xl font-bold text-pixel-text-color">TaskPixel</h2>
      </div>
      <div class="hidden md:flex items-center gap-8 text-sm nav-links">
        <a class="text-black/70 hover:text-primary nav-link" href="index.html">ä¸»é¡µ</a>
        <a class="text-black/70 hover:text-primary nav-link" href="#">æ—¥å†</a>
        <a class="text-black/70 hover:text-primary nav-link" href="goals.html">ç›®æ ‡</a>
        <a class="text-black/70 hover:text-primary nav-link" href="settings.html">è®¾ç½®</a>
        <a class="text-black/70 hover:text-primary nav-link" href="data_management.html">æ•°æ®ç®¡ç†</a>
      </div>
      <!-- header right-side intentionally removed: notifications and avatar placeholders -->
    </header>
    <main class="w-full flex-1 p-4 sm:p-6 md:p-10">
      <div class="mx-auto max-w-7xl">
        <!-- å·¦å³ä¸¤æ å¸ƒå±€ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

          <!-- å·¦ä¾§æ  -->
          <div class="space-y-8">
            <!-- ä»»åŠ¡å¡ç‰‡ -->
            <div class="pixel-border bg-surface p-6">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                <h2 class="font-display text-2xl text-text-primary mb-4 sm:mb-0 task-title"></h2>
                <div class="flex items-center gap-2">
                  <span
                    class="font-display text-sm px-2 py-1 task-status bg-accent-yellow/20 text-accent-yellow-800 border-2 border-accent-yellow-800">è¿›è¡Œä¸­</span>
                </div>
              </div>
              <div class="space-y-6">
                <div>
                  <label class="block font-display text-lg text-text-primary mb-2" for="task-description">æè¿°</label>
                  <p class="text-xl text-text-secondary task-description"></p>
                </div>
                <div class="mt-4">
                  <label class="block font-display text-lg text-text-primary mb-2" for="task-progress">è¿›åº¦</label>
                  <div class="progress-bar">
                    <div class="progress-bar-fill"></div>
                  </div>
                  <p class="text-right text-text-secondary text-lg mt-1 progress-text"></p>
                </div>
              </div>
              <div class="mt-8 flex items-center justify-end gap-4">
                <button
                  class="pixel-button back-button bg-pixel-secondary text-text-primary font-display py-2 px-4 text-sm flex items-center"
                  title="è¿”å›">
                  <span class="material-symbols-outlined align-middle">arrow_back</span>
                </button>
                <button
                  class="pixel-button edit-button bg-accent-blue text-white font-display py-2 px-4 text-sm flex items-center"
                  title="ç¼–è¾‘ä»»åŠ¡">
                  <span class="material-symbols-outlined align-middle">edit</span>
                </button>
                <button
                  class="pixel-button complete-button bg-accent-green text-white font-display py-2 px-4 text-sm flex items-center"
                  title="æ ‡è®°ä¸ºå®Œæˆ">
                  <span class="material-symbols-outlined align-middle">check_circle</span>
                </button>
              </div>
            </div>

            <!-- ç›®æ ‡å’Œå­æ­¥éª¤ -->
            <div class="pixel-border bg-surface p-6">
              <div class="space-y-6 goals-container">
                <!-- ç›®æ ‡å’Œå­æ­¥éª¤å°†é€šè¿‡JavaScriptåŠ¨æ€æ¸²æŸ“ -->
              </div>
            </div>
          </div>

          <!-- å³ä¾§æ  -->
          <div class="space-y-8">
            <!-- è®°å½•å·¥ä½œè¿›åº¦ -->
            <div class="pixel-border bg-surface p-6">
              <h3 class="font-display text-2xl text-text-primary mb-6">è®°å½•å·¥ä½œè¿›åº¦</h3>
              <form id="timeline-form" class="space-y-6">
                <div>
                  <label class="block font-display text-lg text-text-primary mb-2" for="work-content">å·¥ä½œå†…å®¹</label>
                  <textarea id="work-content" placeholder="æè¿°æ‚¨çš„å·¥ä½œ..." rows="4"></textarea>
                </div>
                <div>
                  <label class="block font-display text-lg text-text-primary mb-2" for="time-spent">æ—¶é—´ (å°æ—¶)</label>
                  <input id="time-spent" placeholder="å¦‚ï¼š2" type="number" step="0.1" min="0.1" />
                </div>
                <div>
                  <button type="submit"
                    class="pixel-button w-full bg-accent-green text-white font-display py-3 px-4 text-sm flex items-center justify-center gap-2"
                    title="è®°å½•è¿›åº¦">
                    <span>ğŸ’¾</span>
                    <span>è®°å½•è¿›åº¦</span>
                  </button>
                </div>
              </form>
            </div>

            <!-- è¿›åº¦å†å² -->
            <div class="pixel-border bg-surface p-6">
              <h3 class="font-display text-2xl text-text-primary mb-6">è¿›åº¦å†å²</h3>
              <div class="space-y-4 timeline-container">
                <!-- æ—¶é—´çº¿è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€æ¸²æŸ“ -->
              </div>
            </div>
          </div>

        </div>
      </div>
    </main>
  </div>

  <script>
    // ç¡®ä¿ TaskPixel åç§°ç©ºé—´å­˜åœ¨ï¼Œå³ä½¿ core.js æœªèƒ½æ­£ç¡®åŠ è½½
    window.TaskPixel = window.TaskPixel || {};

    // ç»Ÿä¸€çš„ç¼–è¾‘ä»»åŠ¡å‡½æ•°
    function editTask(taskId) {
      if (!taskId) {
        alert('æœªæ‰¾åˆ°ä»»åŠ¡ID');
        return;
      }

      try {
        const raw = localStorage.getItem('taskpixel_data');
        if (!raw) {
          alert('æœªæ‰¾åˆ°ä»»åŠ¡æ•°æ®');
          return;
        }

        const data = JSON.parse(raw);
        const task = data.tasks.find(t => t.id === taskId);

        if (!task) {
          alert('æœªæ‰¾åˆ°æŒ‡å®šä»»åŠ¡');
          return;
        }

        // åˆ›å»ºç¼–è¾‘å¯¹è¯æ¡†
        const dialogElement = document.createElement('div');
        dialogElement.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
        dialogElement.id = 'edit-task-dialog';

        // è®¡ç®—å½“å‰è¿›åº¦ï¼Œå†³å®šçŠ¶æ€é€‰é¡¹
        let currentProgress = window.TaskPixel?.DataStoreAdapter?.getTaskProgress(taskId) || task.progress || 0;
        let currentStatus = task.status || 'in-progress';
        let isCompleted = currentProgress >= 100;

        dialogElement.innerHTML = `
          <div class="pixel-border bg-white p-6 w-full max-w-lg">
            <h2 class="text-2xl font-display mb-6">ç¼–è¾‘ä»»åŠ¡</h2>
            <form id="edit-task-form">
              <div class="mb-4">
                <label class="block font-display text-lg mb-2" for="edit-task-title">ä»»åŠ¡æ ‡é¢˜</label>
                <input type="text" id="edit-task-title" class="w-full" required placeholder="è¾“å…¥ä»»åŠ¡æ ‡é¢˜" value="${task.title || ''}">
              </div>
              <div class="mb-4">
                <label class="block font-display text-lg mb-2" for="edit-task-description">ä»»åŠ¡æè¿°</label>
                <textarea id="edit-task-description" class="w-full h-32" placeholder="è¾“å…¥ä»»åŠ¡æè¿°">${task.description || ''}</textarea>
              </div>
              ${isCompleted ? `
              <div class="mb-4">
                <label class="block font-display text-lg mb-2">çŠ¶æ€</label>
                <div class="w-full p-2 bg-green-100 text-green-800 border border-green-300 rounded">
                  âœ… å·²å®Œæˆï¼ˆè¿›åº¦100%ï¼Œè‡ªåŠ¨è®¾ç½®ï¼‰
                </div>
              </div>
              ` : `
              <div class="mb-4">
                <label class="block font-display text-lg mb-2" for="edit-task-status">çŠ¶æ€</label>
                <select id="edit-task-status" class="w-full">
                  <option value="in-progress" ${currentStatus === 'in-progress' || currentStatus === 'todo' ? 'selected' : ''}>è¿›è¡Œä¸­</option>
                  <option value="on-hold" ${currentStatus === 'on-hold' ? 'selected' : ''}>æç½®</option>
                </select>
              </div>
              `}
              <div class="mb-4">
                <label class="block font-display text-lg mb-2">å½“å‰è¿›åº¦: ${currentProgress}%</label>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="bg-blue-600 h-2 rounded-full" style="width: ${currentProgress}%"></div>
                </div>
              </div>
              <div class="flex justify-end gap-4">
                <button type="button" id="cancel-edit-task" class="pixel-button">å–æ¶ˆ</button>
                <button type="submit" class="pixel-button bg-primary text-white">ä¿å­˜</button>
              </div>
            </form>
          </div>
        `;

        document.body.appendChild(dialogElement);

        // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
        document.getElementById('edit-task-form').addEventListener('submit', function (e) {
          e.preventDefault();

          const title = document.getElementById('edit-task-title').value.trim();
          const description = document.getElementById('edit-task-description').value.trim();

          if (!title) {
            alert('ä»»åŠ¡æ ‡é¢˜ä¸èƒ½ä¸ºç©º');
            return;
          }

          // ç¡®å®šæœ€ç»ˆçŠ¶æ€
          let finalStatus;
          const progress = window.TaskPixel?.DataStoreAdapter?.getTaskProgress(taskId) || task.progress || 0;

          if (progress >= 100) {
            finalStatus = 'completed';
          } else {
            const statusSelect = document.getElementById('edit-task-status');
            finalStatus = statusSelect ? statusSelect.value : 'in-progress';
          }

          // æ›´æ–°ä»»åŠ¡æ•°æ®
          task.title = title;
          task.description = description;
          task.status = finalStatus;

          // ä¿å­˜åˆ°localStorage
          localStorage.setItem('taskpixel_data', JSON.stringify(data));

          // å…³é—­å¯¹è¯æ¡†
          document.getElementById('edit-task-dialog').remove();

          // åˆ·æ–°é¡µé¢
          location.reload();
        });

        // ç»‘å®šå–æ¶ˆæŒ‰é’®
        document.getElementById('cancel-edit-task').addEventListener('click', function () {
          document.getElementById('edit-task-dialog').remove();
        });

      } catch (e) {
        alert('ç¼–è¾‘ä»»åŠ¡å‡ºé”™: ' + e.message);
      }
    }

    // ç»Ÿä¸€çš„å®Œæˆä»»åŠ¡å‡½æ•°
    function completeTask(taskId) {
      if (!taskId) {
        alert('æœªæ‰¾åˆ°ä»»åŠ¡ID');
        return;
      }

      try {
        const raw = localStorage.getItem('taskpixel_data');
        if (!raw) {
          alert('æœªæ‰¾åˆ°ä»»åŠ¡æ•°æ®');
          return;
        }

        const data = JSON.parse(raw);
        const task = data.tasks.find(t => t.id === taskId);

        if (!task) {
          alert('æœªæ‰¾åˆ°æŒ‡å®šä»»åŠ¡');
          return;
        }

        // åˆ‡æ¢å®ŒæˆçŠ¶æ€
        task.status = task.status === 'completed' ? 'in-progress' : 'completed';

        // å¦‚æœæ ‡è®°ä¸ºå®Œæˆï¼Œè®¾ç½®è¿›åº¦ä¸º100%
        if (task.status === 'completed') {
          task.progress = 100;
        }

        // ä¿å­˜åˆ°localStorage
        localStorage.setItem('taskpixel_data', JSON.stringify(data));

        // åˆ·æ–°é¡µé¢
        location.reload();

      } catch (e) {
        alert('æ›´æ–°ä»»åŠ¡çŠ¶æ€æ—¶å‡ºé”™: ' + e.message);
      }
    }

    // æ·»åŠ å·¥ä½œè¿›åº¦è®°å½•
    function addWorkProgress(taskId, content, hours) {
      if (!taskId) {
        alert('æœªæ‰¾åˆ°ä»»åŠ¡ID');
        return;
      }

      try {
        const raw = localStorage.getItem('taskpixel_data');
        if (!raw) {
          alert('æœªæ‰¾åˆ°ä»»åŠ¡æ•°æ®');
          return;
        }

        const data = JSON.parse(raw);
        const task = data.tasks.find(t => t.id === taskId);

        if (!task) {
          alert('æœªæ‰¾åˆ°æŒ‡å®šä»»åŠ¡');
          return;
        }

        // åˆå§‹åŒ–timelineæ•°ç»„
        if (!task.timeline) {
          task.timeline = [];
        }

        // åˆ›å»ºæ–°çš„è¿›åº¦è®°å½•
        const progressEntry = {
          id: 'progress-' + Date.now(),
          date: new Date().toISOString(),
          content: content,
          hours: hours,
          timestamp: Date.now()
        };

        task.timeline.push(progressEntry);

        // æ›´æ–°æ€»å·¥ä½œæ—¶é—´
        const totalHours = task.timeline.reduce((sum, entry) => sum + (entry.hours || 0), 0);
        task.totalHours = totalHours;

        // ä¿å­˜åˆ°localStorage
        localStorage.setItem('taskpixel_data', JSON.stringify(data));

        // æ¸…ç©ºè¡¨å•
        document.getElementById('work-content').value = '';
        document.getElementById('time-spent').value = '';

        // é‡æ–°æ¸²æŸ“è¿›åº¦å†å²
        renderProgressHistory(task.timeline);

        alert('å·¥ä½œè¿›åº¦è®°å½•æˆåŠŸï¼');

      } catch (e) {
        alert('è®°å½•å·¥ä½œè¿›åº¦æ—¶å‡ºé”™: ' + e.message);
      }
    }

    // æ¸²æŸ“è¿›åº¦å†å²
    function renderProgressHistory(timeline) {
      const container = document.querySelector('.timeline-container');
      if (!container) return;

      container.innerHTML = '';

      if (!timeline || timeline.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8">
            <p class="text-gray-500 mb-4">è¿˜æ²¡æœ‰å·¥ä½œè¿›åº¦è®°å½•</p>
            <p class="text-gray-400 text-sm">å¼€å§‹è®°å½•æ‚¨çš„å·¥ä½œè¿›åº¦å§ï¼</p>
          </div>
        `;
        return;
      }

      // æŒ‰æ—¶é—´å€’åºæ’åˆ—
      const sortedTimeline = [...timeline].sort((a, b) => b.timestamp - a.timestamp);

      sortedTimeline.forEach(entry => {
        const entryElement = document.createElement('div');
        entryElement.className = 'pixel-border bg-white p-4 mb-4 hover:shadow-lg transition-shadow';

        const date = new Date(entry.date);
        const formattedDate = date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });

        entryElement.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <div class="flex items-center gap-2">
              <div class="w-3 h-3 bg-primary"></div>
              <span class="font-display text-sm text-gray-600">${formattedDate}</span>
            </div>
            <span class="pixel-button bg-primary text-white px-3 py-1 text-xs">${entry.hours} å°æ—¶</span>
          </div>
          <div class="pl-5">
            <p class="font-display text-lg text-text-primary">${entry.content}</p>
          </div>
        `;

        container.appendChild(entryElement);
      });
    }
  </script>
  <script src="js/core.js"></script>
  <script src="js/dataStoreAdapter.js"></script>
  <script src="js/aiAssist.js"></script>
  <script src="js/taskDetail.js"></script>
  <script src="js/taskDetailFix-clean.js"></script>
  <script src="js/taskProgressFix-clean.js"></script>
  <script src="js/goalsFix-clean.js"></script>
  <script>
    // ç®€åŒ–çš„åˆå§‹åŒ–è„šæœ¬ - ç§»é™¤æ‰€æœ‰è°ƒè¯•è¾“å‡º
    document.addEventListener('DOMContentLoaded', function () {
      // åŸºç¡€æŒ‰é’®äº‹ä»¶
      document.querySelector('.back-button')?.addEventListener('click', function () {
        window.location.href = 'index.html';
      });

      document.querySelector('.edit-button')?.addEventListener('click', function () {
        const taskId = new URLSearchParams(window.location.search).get('id') || window.currentTaskId;
        editTask(taskId);
      });

      document.querySelector('.complete-button')?.addEventListener('click', function () {
        const taskId = new URLSearchParams(window.location.search).get('id');
        completeTask(taskId);
      });

      // è®°å½•å·¥ä½œè¿›åº¦è¡¨å•å¤„ç†
      document.getElementById('timeline-form')?.addEventListener('submit', function (e) {
        e.preventDefault();
        const taskId = new URLSearchParams(window.location.search).get('id');
        const workContent = document.getElementById('work-content').value.trim();
        const timeSpent = parseFloat(document.getElementById('time-spent').value);

        if (!workContent) {
          alert('è¯·è¾“å…¥å·¥ä½œå†…å®¹');
          return;
        }
        if (!timeSpent || timeSpent <= 0) {
          alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å·¥ä½œæ—¶é—´');
          return;
        }

        addWorkProgress(taskId, workContent, timeSpent);
      });

      // åˆå§‹åŒ– TaskPixel
      try {
        if (typeof TaskPixel?.init === 'function') {
          TaskPixel.init();
        }
      } catch (e) {
        // é™é»˜å¤„ç†é”™è¯¯
      }

      // åˆå§‹åŒ– TaskDetail
      try {
        const taskId = new URLSearchParams(window.location.search).get('id');
        if (taskId && window.TaskPixel?.TaskDetail?.init) {
          window.currentTaskId = taskId;
          TaskPixel.TaskDetail.currentTaskId = taskId;
          TaskPixel.TaskDetail.init();
        }
      } catch (e) {
        // é™é»˜å¤„ç†é”™è¯¯
      }

      // å¤‡ç”¨æ•°æ®æ˜¾ç¤ºé€»è¾‘ - ç¡®ä¿ä»»åŠ¡ä¿¡æ¯èƒ½å¤Ÿæ˜¾ç¤º
      setTimeout(function () {
        const taskId = new URLSearchParams(window.location.search).get('id');
        if (taskId) {
          try {
            const raw = localStorage.getItem('taskpixel_data');
            if (raw) {
              const data = JSON.parse(raw);
              const task = (data.tasks || []).find(t => t.id === taskId);

              if (task) {
                // æ›´æ–°æ ‡é¢˜
                const titleEl = document.querySelector('.task-title');
                if (titleEl && !titleEl.textContent.includes(task.title)) {
                  titleEl.textContent = 'ä»»åŠ¡: ' + task.title;
                }

                // æ›´æ–°æè¿°
                const descEl = document.querySelector('.task-description');
                if (descEl && !descEl.textContent) {
                  descEl.textContent = task.description || 'æš‚æ— æè¿°';
                }

                // æ›´æ–°è¿›åº¦ - ä½¿ç”¨ç»Ÿä¸€çš„ updateProgressBar å‡½æ•°
                updateProgressBar(taskId);

                // æ›´æ–°çŠ¶æ€
                const statusEl = document.querySelector('.task-status');
                if (statusEl) {
                  let statusText = 'è¿›è¡Œä¸­';
                  let statusClass = 'bg-accent-yellow/20 text-accent-yellow-800 border-accent-yellow-800';

                  switch (task.status) {
                    case 'todo':
                      statusText = 'å¾…å¤„ç†';
                      statusClass = 'bg-accent-blue/20 text-accent-blue-800 border-accent-blue-800';
                      break;
                    case 'on-hold':
                      statusText = 'æç½®';
                      statusClass = 'bg-accent-red/20 text-accent-red-800 border-accent-red-800';
                      break;
                    case 'completed':
                      statusText = 'å·²å®Œæˆ';
                      statusClass = 'bg-accent-green/20 text-accent-green-800 border-accent-green-800';
                      break;
                    case 'in-progress':
                    default:
                      statusText = 'è¿›è¡Œä¸­';
                      statusClass = 'bg-accent-yellow/20 text-accent-yellow-800 border-accent-yellow-800';
                      break;
                  }
                  statusEl.textContent = statusText;

                  // æ›´æ–°çŠ¶æ€æ ·å¼
                  statusEl.className = `font-display text-sm px-2 py-1 task-status border-2 ${statusClass}`;
                }

                // æ¸²æŸ“ç›®æ ‡
                const goalsContainer = document.querySelector('.goals-container');
                if (goalsContainer) {
                  renderGoals(task.goals || [], taskId);
                  // æ¸²æŸ“ç›®æ ‡åæ›´æ–°è¿›åº¦æ¡
                  updateProgressBar(taskId);
                }

                // æ¸²æŸ“è¿›åº¦å†å²
                if (task.timeline) {
                  renderProgressHistory(task.timeline);
                }
              }
            }
          } catch (e) {
            // é™é»˜å¤„ç†é”™è¯¯
          }
        }
      }, 1000);

      // ç›®æ ‡æ¸²æŸ“å‡½æ•°
      function renderGoals(goals, taskId) {
        const goalsContainer = document.querySelector('.goals-container');
        if (!goalsContainer) return;

        // æ¸…ç©ºå®¹å™¨
        goalsContainer.innerHTML = '';

        // æ·»åŠ æ ‡é¢˜å’ŒAIåŠ©æ‰‹æŒ‰é’®
        const header = document.createElement('div');
        header.className = 'flex items-center justify-between mb-6';
        header.innerHTML = `
          <h3 class="font-display text-2xl text-text-primary">ç›®æ ‡ä¸å­æ­¥éª¤</h3>
          <button class="pixel-button bg-purple-600 text-white px-4 py-2 text-sm">
            <span class="mr-2">âœ¨</span>AI åŠ©æ‰‹
          </button>
        `;
        goalsContainer.appendChild(header);

        // æ¸²æŸ“ç›®æ ‡åˆ—è¡¨
        if (goals && goals.length > 0) {
          goals.forEach(goal => {
            const goalCard = createGoalCard(goal, taskId);
            goalsContainer.appendChild(goalCard);
          });

          // æ·»åŠ "æ·»åŠ æ–°ç›®æ ‡"æŒ‰é’®
          const addButton = document.createElement('div');
          addButton.className = 'text-center mt-6';
          addButton.innerHTML = `
            <button class="pixel-button bg-primary text-white px-4 py-2 add-goal-btn" title="æ·»åŠ æ–°ç›®æ ‡">ğŸ¯ â•</button>
          `;
          goalsContainer.appendChild(addButton);
        } else {
          // ç©ºçŠ¶æ€
          const emptyState = document.createElement('div');
          emptyState.className = 'text-center py-8';
          emptyState.innerHTML = `
            <p class="text-gray-500 mb-4">è¿˜æ²¡æœ‰è®¾ç½®ç›®æ ‡</p>
            <button class="pixel-button bg-primary text-white px-4 py-2 add-goal-btn" title="æ·»åŠ ç›®æ ‡">ğŸ¯ â•</button>
          `;
          goalsContainer.appendChild(emptyState);
        }

        // ç»‘å®šæ·»åŠ ç›®æ ‡æŒ‰é’®
        bindAddGoalEvents(taskId);
      }

      // åˆ›å»ºç›®æ ‡å¡ç‰‡
      function createGoalCard(goal, taskId) {
        const card = document.createElement('div');
        card.className = 'border-4 border-black bg-white mb-6 p-4 goal-card';
        card.dataset.goalId = goal.id;

        // è®¡ç®—è¿›åº¦
        const total = goal.substeps ? goal.substeps.length : 0;
        const completed = goal.substeps ? goal.substeps.filter(s => s.completed).length : 0;

        card.innerHTML = `
          <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
              <h4 class="font-display text-lg font-bold mb-2">${goal.title || 'æœªå‘½åç›®æ ‡'}</h4>
              <p class="text-gray-600 text-sm mb-2">${goal.description || ''}</p>
            </div>
            <div class="flex gap-2">
              <button class="pixel-button-flat bg-green-500 text-white px-3 py-1 text-xs edit-goal-btn" 
                      data-goal-id="${goal.id}" title="ä¿®æ”¹ç›®æ ‡">âœï¸</button>
              <button class="pixel-button-flat bg-blue-500 text-white px-3 py-1 text-xs add-substep-btn" 
                      data-goal-id="${goal.id}" title="æ·»åŠ å­æ­¥éª¤">â•</button>
              <button class="pixel-button-flat bg-red-500 text-white px-3 py-1 text-xs delete-goal-btn" 
                      data-goal-id="${goal.id}" title="åˆ é™¤ç›®æ ‡">ğŸ—‘ï¸</button>
            </div>
          </div>
          
          <div class="substeps-container">
            ${goal.substeps ? goal.substeps.map(substep => `
              <div class="flex items-center gap-3 py-2 px-3 hover:bg-gray-50 substep-item" data-substep-id="${substep.id}">
                <input type="checkbox" ${substep.completed ? 'checked' : ''} 
                       class="substep-checkbox w-4 h-4" 
                       data-goal-id="${goal.id}" 
                       data-substep-id="${substep.id}">
                <span class="flex-1 ${substep.completed ? 'line-through text-gray-500' : ''}">${substep.content || substep.title}</span>
                <div class="flex gap-1">
                  <button class="pixel-button-flat bg-green-500 text-white px-2 py-1 text-xs edit-substep-btn" 
                          data-goal-id="${goal.id}" 
                          data-substep-id="${substep.id}" title="ä¿®æ”¹å­æ­¥éª¤">âœï¸</button>
                  <button class="pixel-button-flat bg-red-500 text-white px-2 py-1 text-xs delete-substep-btn" 
                          data-goal-id="${goal.id}" 
                          data-substep-id="${substep.id}" title="åˆ é™¤å­æ­¥éª¤">ğŸ—‘ï¸</button>
                </div>
              </div>
            `).join('') : ''}
          </div>
        `;

        // ç»‘å®šäº‹ä»¶
        bindGoalCardEvents(card, goal, taskId);

        return card;
      }

      // ç»‘å®šç›®æ ‡å¡ç‰‡äº‹ä»¶
      function bindGoalCardEvents(card, goal, taskId) {
        // æ·»åŠ å­æ­¥éª¤
        const addBtn = card.querySelector('.add-substep-btn');
        if (addBtn) {
          addBtn.addEventListener('click', () => openAddSubstepDialog(goal.id, taskId));
        }

        // ä¿®æ”¹ç›®æ ‡
        const editBtn = card.querySelector('.edit-goal-btn');
        if (editBtn) {
          editBtn.addEventListener('click', () => openEditGoalDialog(goal.id, taskId));
        }

        // åˆ é™¤ç›®æ ‡
        const deleteBtn = card.querySelector('.delete-goal-btn');
        if (deleteBtn) {
          deleteBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç›®æ ‡å—ï¼Ÿ')) {
              deleteGoal(taskId, goal.id);
            }
          });
        }

        // å¤é€‰æ¡†äº‹ä»¶
        const checkboxes = card.querySelectorAll('.substep-checkbox');
        checkboxes.forEach(checkbox => {
          checkbox.addEventListener('change', function () {
            updateSubstepStatus(
              taskId,
              this.dataset.goalId,
              this.dataset.substepId,
              this.checked
            );
          });
        });

        // ä¿®æ”¹å­æ­¥éª¤æŒ‰é’®
        const editSubstepButtons = card.querySelectorAll('.edit-substep-btn');
        editSubstepButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            openEditSubstepDialog(taskId, btn.dataset.goalId, btn.dataset.substepId);
          });
        });

        // åˆ é™¤å­æ­¥éª¤æŒ‰é’®
        const deleteButtons = card.querySelectorAll('.delete-substep-btn');
        deleteButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­æ­¥éª¤å—ï¼Ÿ')) {
              deleteSubstep(taskId, btn.dataset.goalId, btn.dataset.substepId);
            }
          });
        });
      }

      // ç»‘å®šæ·»åŠ ç›®æ ‡äº‹ä»¶
      function bindAddGoalEvents(taskId) {
        const addBtns = document.querySelectorAll('.add-goal-btn');
        addBtns.forEach(btn => {
          btn.addEventListener('click', () => openAddGoalDialog(taskId));
        });
      }

      // æ‰“å¼€æ·»åŠ ç›®æ ‡å¯¹è¯æ¡†
      function openAddGoalDialog(taskId) {
        const dialog = document.createElement('div');
        dialog.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
        dialog.id = 'add-goal-dialog';

        dialog.innerHTML = `
          <div class="pixel-border bg-white p-6 w-full max-w-lg">
            <h2 class="text-2xl font-display mb-6">æ·»åŠ ç›®æ ‡</h2>
            <form id="add-goal-form">
              <div class="mb-4">
                <label class="block font-display text-lg mb-2" for="goal-title">ç›®æ ‡æ ‡é¢˜ *</label>
                <input type="text" id="goal-title" class="w-full" required placeholder="è¾“å…¥ç›®æ ‡æ ‡é¢˜">
              </div>
              <div class="mb-4">
                <label class="block font-display text-lg mb-2" for="goal-description">ç›®æ ‡æè¿°</label>
                <textarea id="goal-description" class="w-full h-32" placeholder="è¾“å…¥ç›®æ ‡æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
              </div>
              <div class="flex justify-end gap-4">
                <button type="button" id="cancel-add-goal" class="pixel-button">å–æ¶ˆ</button>
                <button type="submit" class="pixel-button bg-primary text-white">æ·»åŠ </button>
              </div>
            </form>
          </div>
        `;

        document.body.appendChild(dialog);

        // ç»‘å®šäº‹ä»¶
        document.getElementById('add-goal-form').addEventListener('submit', function (e) {
          e.preventDefault();
          const title = document.getElementById('goal-title').value.trim();
          const description = document.getElementById('goal-description').value.trim();

          if (!title) {
            alert('è¯·è¾“å…¥ç›®æ ‡æ ‡é¢˜');
            return;
          }

          addGoal(taskId, title, description);
          dialog.remove();
        });

        document.getElementById('cancel-add-goal').addEventListener('click', () => {
          dialog.remove();
        });

        // èšç„¦åˆ°æ ‡é¢˜è¾“å…¥æ¡†
        setTimeout(() => {
          document.getElementById('goal-title').focus();
        }, 100);
      }

      // æ·»åŠ ç›®æ ‡
      function addGoal(taskId, title, description) {
        try {
          const raw = localStorage.getItem('taskpixel_data');
          if (raw) {
            const data = JSON.parse(raw);
            const task = data.tasks.find(t => t.id === taskId);
            if (task) {
              if (!task.goals) task.goals = [];

              const newGoal = {
                id: 'goal-' + Date.now(),
                title: title,
                description: description || '',
                substeps: []
              };

              task.goals.push(newGoal);
              localStorage.setItem('taskpixel_data', JSON.stringify(data));

              // é‡æ–°æ¸²æŸ“
              renderGoals(task.goals, taskId);
            }
          }
        } catch (e) {
          alert('æ·»åŠ ç›®æ ‡å¤±è´¥: ' + e.message);
        }
      }

      // æ‰“å¼€ä¿®æ”¹ç›®æ ‡å¯¹è¯æ¡†
      function openEditGoalDialog(goalId, taskId) {
        try {
          const raw = localStorage.getItem('taskpixel_data');
          if (!raw) return;

          const data = JSON.parse(raw);
          const task = data.tasks.find(t => t.id === taskId);
          if (!task || !task.goals) return;

          const goal = task.goals.find(g => g.id === goalId);
          if (!goal) return;

          const dialog = document.createElement('div');
          dialog.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
          dialog.id = 'edit-goal-dialog';

          dialog.innerHTML = `
            <div class="pixel-border bg-white p-6 w-full max-w-lg">
              <h2 class="text-2xl font-display mb-6">ä¿®æ”¹ç›®æ ‡</h2>
              <form id="edit-goal-form">
                <div class="mb-4">
                  <label class="block font-display text-lg mb-2" for="edit-goal-title">ç›®æ ‡æ ‡é¢˜ *</label>
                  <input type="text" id="edit-goal-title" class="w-full" required placeholder="è¾“å…¥ç›®æ ‡æ ‡é¢˜" value="${goal.title || ''}">
                </div>
                <div class="mb-4">
                  <label class="block font-display text-lg mb-2" for="edit-goal-description">ç›®æ ‡æè¿°</label>
                  <textarea id="edit-goal-description" class="w-full h-32" placeholder="è¾“å…¥ç›®æ ‡æè¿°ï¼ˆå¯é€‰ï¼‰">${goal.description || ''}</textarea>
                </div>
                <div class="flex justify-end gap-4">
                  <button type="button" id="cancel-edit-goal" class="pixel-button">å–æ¶ˆ</button>
                  <button type="submit" class="pixel-button bg-primary text-white">ä¿å­˜</button>
                </div>
              </form>
            </div>
          `;

          document.body.appendChild(dialog);

          // ç»‘å®šäº‹ä»¶
          document.getElementById('edit-goal-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const title = document.getElementById('edit-goal-title').value.trim();
            const description = document.getElementById('edit-goal-description').value.trim();

            if (!title) {
              alert('è¯·è¾“å…¥ç›®æ ‡æ ‡é¢˜');
              return;
            }

            // æ›´æ–°ç›®æ ‡
            goal.title = title;
            goal.description = description;
            localStorage.setItem('taskpixel_data', JSON.stringify(data));

            // é‡æ–°æ¸²æŸ“
            renderGoals(task.goals, taskId);
            dialog.remove();
          });

          document.getElementById('cancel-edit-goal').addEventListener('click', () => {
            dialog.remove();
          });

          // èšç„¦åˆ°æ ‡é¢˜è¾“å…¥æ¡†
          setTimeout(() => {
            document.getElementById('edit-goal-title').focus();
          }, 100);

        } catch (e) {
          alert('ä¿®æ”¹ç›®æ ‡å¤±è´¥: ' + e.message);
        }
      }

      // åˆ é™¤ç›®æ ‡
      function deleteGoal(taskId, goalId) {
        try {
          const raw = localStorage.getItem('taskpixel_data');
          if (raw) {
            const data = JSON.parse(raw);
            const task = data.tasks.find(t => t.id === taskId);
            if (task && task.goals) {
              task.goals = task.goals.filter(g => g.id !== goalId);
              localStorage.setItem('taskpixel_data', JSON.stringify(data));

              // é‡æ–°æ¸²æŸ“
              renderGoals(task.goals, taskId);
              updateProgressBar(taskId);
            }
          }
        } catch (e) {
          alert('åˆ é™¤ç›®æ ‡å¤±è´¥: ' + e.message);
        }
      }

      // æ‰“å¼€æ·»åŠ å­æ­¥éª¤å¯¹è¯æ¡†
      function openAddSubstepDialog(goalId, taskId) {
        const dialog = document.createElement('div');
        dialog.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
        dialog.id = 'add-substep-dialog';

        dialog.innerHTML = `
          <div class="pixel-border bg-white p-6 w-full max-w-lg">
            <h2 class="text-2xl font-display mb-6">æ·»åŠ å­æ­¥éª¤</h2>
            <form id="add-substep-form">
              <div class="mb-4">
                <label class="block font-display text-lg mb-2" for="substep-content">å­æ­¥éª¤å†…å®¹ *</label>
                <input type="text" id="substep-content" class="w-full" required placeholder="è¾“å…¥å­æ­¥éª¤å†…å®¹">
              </div>
              <div class="flex justify-end gap-4">
                <button type="button" id="cancel-add-substep" class="pixel-button">å–æ¶ˆ</button>
                <button type="submit" class="pixel-button bg-primary text-white">æ·»åŠ </button>
              </div>
            </form>
          </div>
        `;

        document.body.appendChild(dialog);

        // ç»‘å®šäº‹ä»¶
        document.getElementById('add-substep-form').addEventListener('submit', function (e) {
          e.preventDefault();
          const content = document.getElementById('substep-content').value.trim();

          if (!content) {
            alert('è¯·è¾“å…¥å­æ­¥éª¤å†…å®¹');
            return;
          }

          addSubstep(goalId, taskId, content);
          dialog.remove();
        });

        document.getElementById('cancel-add-substep').addEventListener('click', () => {
          dialog.remove();
        });

        // èšç„¦åˆ°å†…å®¹è¾“å…¥æ¡†
        setTimeout(() => {
          document.getElementById('substep-content').focus();
        }, 100);
      }

      // æ·»åŠ å­æ­¥éª¤
      function addSubstep(goalId, taskId, content) {
        try {
          const raw = localStorage.getItem('taskpixel_data');
          if (raw) {
            const data = JSON.parse(raw);
            const task = data.tasks.find(t => t.id === taskId);
            if (task && task.goals) {
              const goal = task.goals.find(g => g.id === goalId);
              if (goal) {
                if (!goal.substeps) goal.substeps = [];

                const newSubstep = {
                  id: 'substep-' + Date.now(),
                  content: content,
                  completed: false
                };

                goal.substeps.push(newSubstep);
                localStorage.setItem('taskpixel_data', JSON.stringify(data));

                // é‡æ–°æ¸²æŸ“
                renderGoals(task.goals, taskId);
                updateProgressBar(taskId);
              }
            }
          }
        } catch (e) {
          alert('æ·»åŠ å­æ­¥éª¤å¤±è´¥: ' + e.message);
        }
      }

      // æ‰“å¼€ä¿®æ”¹å­æ­¥éª¤å¯¹è¯æ¡†
      function openEditSubstepDialog(taskId, goalId, substepId) {
        try {
          const raw = localStorage.getItem('taskpixel_data');
          if (!raw) return;

          const data = JSON.parse(raw);
          const task = data.tasks.find(t => t.id === taskId);
          if (!task || !task.goals) return;

          const goal = task.goals.find(g => g.id === goalId);
          if (!goal || !goal.substeps) return;

          const substep = goal.substeps.find(s => s.id === substepId);
          if (!substep) return;

          const dialog = document.createElement('div');
          dialog.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
          dialog.id = 'edit-substep-dialog';

          dialog.innerHTML = `
            <div class="pixel-border bg-white p-6 w-full max-w-lg">
              <h2 class="text-2xl font-display mb-6">ä¿®æ”¹å­æ­¥éª¤</h2>
              <form id="edit-substep-form">
                <div class="mb-4">
                  <label class="block font-display text-lg mb-2" for="edit-substep-content">å­æ­¥éª¤å†…å®¹ *</label>
                  <input type="text" id="edit-substep-content" class="w-full" required placeholder="è¾“å…¥å­æ­¥éª¤å†…å®¹" value="${substep.content || substep.title || ''}">
                </div>
                <div class="mb-4">
                  <label class="flex items-center">
                    <input type="checkbox" id="edit-substep-completed" ${substep.completed ? 'checked' : ''} class="mr-2">
                    <span class="font-display text-lg">å·²å®Œæˆ</span>
                  </label>
                </div>
                <div class="flex justify-end gap-4">
                  <button type="button" id="cancel-edit-substep" class="pixel-button">å–æ¶ˆ</button>
                  <button type="submit" class="pixel-button bg-primary text-white">ä¿å­˜</button>
                </div>
              </form>
            </div>
          `;

          document.body.appendChild(dialog);

          // ç»‘å®šäº‹ä»¶
          document.getElementById('edit-substep-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const content = document.getElementById('edit-substep-content').value.trim();
            const completed = document.getElementById('edit-substep-completed').checked;

            if (!content) {
              alert('è¯·è¾“å…¥å­æ­¥éª¤å†…å®¹');
              return;
            }

            // æ›´æ–°å­æ­¥éª¤
            substep.content = content;
            substep.completed = completed;
            localStorage.setItem('taskpixel_data', JSON.stringify(data));

            // é‡æ–°æ¸²æŸ“
            renderGoals(task.goals, taskId);
            updateProgressBar(taskId);
            dialog.remove();
          });

          document.getElementById('cancel-edit-substep').addEventListener('click', () => {
            dialog.remove();
          });

          // èšç„¦åˆ°å†…å®¹è¾“å…¥æ¡†
          setTimeout(() => {
            document.getElementById('edit-substep-content').focus();
          }, 100);

        } catch (e) {
          alert('ä¿®æ”¹å­æ­¥éª¤å¤±è´¥: ' + e.message);
        }
      }

      // åˆ é™¤å­æ­¥éª¤
      function deleteSubstep(taskId, goalId, substepId) {
        try {
          const raw = localStorage.getItem('taskpixel_data');
          if (raw) {
            const data = JSON.parse(raw);
            const task = data.tasks.find(t => t.id === taskId);
            if (task && task.goals) {
              const goal = task.goals.find(g => g.id === goalId);
              if (goal && goal.substeps) {
                goal.substeps = goal.substeps.filter(s => s.id !== substepId);
                localStorage.setItem('taskpixel_data', JSON.stringify(data));

                // é‡æ–°æ¸²æŸ“
                renderGoals(task.goals, taskId);
                updateProgressBar(taskId);
              }
            }
          }
        } catch (e) {
          alert('åˆ é™¤å­æ­¥éª¤å¤±è´¥: ' + e.message);
        }
      }

      // æ›´æ–°å­æ­¥éª¤çŠ¶æ€
      function updateSubstepStatus(taskId, goalId, substepId, completed) {
        try {
          const raw = localStorage.getItem('taskpixel_data');
          if (raw) {
            const data = JSON.parse(raw);
            const task = data.tasks.find(t => t.id === taskId);
            if (task && task.goals) {
              const goal = task.goals.find(g => g.id === goalId);
              if (goal && goal.substeps) {
                const substep = goal.substeps.find(s => s.id === substepId);
                if (substep) {
                  substep.completed = completed;
                  localStorage.setItem('taskpixel_data', JSON.stringify(data));

                  // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°è¿›åº¦
                  renderGoals(task.goals, taskId);
                  updateProgressBar(taskId);
                }
              }
            }
          }
        } catch (e) {
          alert('æ›´æ–°å­æ­¥éª¤çŠ¶æ€å¤±è´¥: ' + e.message);
        }
      }

      // æ›´æ–°è¿›åº¦æ¡
      function updateProgressBar(taskId) {
        if (!taskId) {
          console.warn('updateProgressBar: taskId is missing');
          return;
        }

        setTimeout(() => {
          try {
            // è·å–å®é™…è¿›åº¦
            let actualProgress = 0;

            if (window.TaskPixel?.DataStoreAdapter?.getTaskProgress) {
              actualProgress = window.TaskPixel.DataStoreAdapter.getTaskProgress(taskId);
            } else {
              // å¤‡ç”¨è®¡ç®—æ–¹æ³•
              const raw = localStorage.getItem('taskpixel_data');
              if (raw) {
                const data = JSON.parse(raw);
                const task = data.tasks?.find(t => t.id === taskId);
                if (task) {
                  // è®¡ç®—åŸºäºç›®æ ‡å’Œå­æ­¥éª¤çš„è¿›åº¦
                  let totalSubsteps = 0;
                  let completedSubsteps = 0;

                  if (task.goals && Array.isArray(task.goals)) {
                    task.goals.forEach(goal => {
                      if (goal.substeps && Array.isArray(goal.substeps)) {
                        goal.substeps.forEach(substep => {
                          totalSubsteps++;
                          if (substep.completed) {
                            completedSubsteps++;
                          }
                        });
                      }
                    });
                  }

                  actualProgress = totalSubsteps > 0 ? Math.round((completedSubsteps / totalSubsteps) * 100) : 0;
                }
              }
            }

            // æ›´æ–°è¿›åº¦æ¡
            const progressEl = document.querySelector('.progress-bar-fill');
            const progressTextEl = document.querySelector('.progress-text');

            if (progressEl) {
              progressEl.style.width = actualProgress + '%';
            }
            if (progressTextEl) {
              progressTextEl.textContent = actualProgress + '% å®Œæˆ';
            }

            console.log(`Progress updated for task ${taskId}: ${actualProgress}%`);

          } catch (e) {
            console.error('Error updating progress bar:', e);
          }
        }, 100);
      }

    });
  </script>
</body>

</html>